<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Калькулятор раціону з 4 вкладками</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Шрифт в Apple-стилі (SF Pro Display). Якщо не встановлено, fallback на системні -->
    <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap');
    </style>

    <style>
        /* СБРОС */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont,
                         "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background: #f2f2f5;
            color: #1D1D1F;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #e5e5e7 0%, #cacacc 100%);
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        header h3 {
            font-size: 1.1rem;
            font-weight: 400;
            color: #444;
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        .tab-buttons button {
            background: #e4e4e7;
            border: 1px solid #ccc;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.2s;
            font-size: 15px;
        }
        .tab-buttons button:hover {
            background: #d8d8da;
        }
        .tab-content {
            display: none;
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .active {
            display: block;
        }

        .form-group {
            margin-bottom: 12px;
        }
        label {
            font-weight: 500;
            display: block;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        select, input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
        }
        select:focus, input:focus {
            outline: 1px solid #0071E3;
        }

        button.calculate {
            background: #0071E3;
            border: none;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        button.calculate:hover {
            background: #005BB5;
        }

        #result, #compatibilityResult {
            margin-top: 20px;
            display: none;
            background: #fafafa;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th {
            background: #f5f5f7;
            font-weight: 500;
            padding: 8px;
            text-align: left;
            font-size: 0.9rem;
        }
        td {
            padding: 8px;
            font-size: 0.9rem;
        }

        .note {
            font-size: 0.85rem;
            margin-top: 12px;
            color: #666;
        }

        .desktop-flex {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .desktop-half {
            flex: 1 0 48%;
            min-width: 300px;
        }

        .tab2-flex {
            display: flex;
            gap: 20px;
        }
        .macro-block, .micro-block {
            flex: 1;
            min-width: 300px;
        }

        .tab3-flex {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .tab3-half {
            flex: 1 0 48%;
            min-width: 300px;
        }

        /* Четвёрта вкладка: список кормів + можливість редагування */
        .feed-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
        }
        .feed-row input {
            width: 100px;
            font-size: 0.8rem;
        }
        .feed-row label {
            margin-bottom: 2px;
        }
        .feed-actions {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
        }
        .feed-edit-btn, .feed-save-btn, .feed-cancel-btn, .feed-delete-btn {
            background: #0071E3;
            color: #fff;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .feed-delete-btn {
            background: #b00020;
        }
        .feed-save-btn {
            background: #009e0f;
        }
        .feed-cancel-btn {
            background: #888;
        }

        @media (max-width: 900px) {
            .desktop-flex, .tab2-flex, .tab3-flex {
                flex-direction: column;
            }
            .desktop-half, .macro-block, .micro-block, .tab3-half {
                flex: 1 0 100%;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>Калькулятор раціону (4 вкладки)</h1>
        <h3>з перевіркою корму, базою і списком для редагування</h3>
    </header>

    <div class="tab-buttons">
        <button onclick="openTab('tab1')">1) Розрахунок раціону</button>
        <button onclick="openTab('tab2')">2) Сумісність корму</button>
        <button onclick="openTab('tab3')">3) Створити/Внести корм</button>
        <button onclick="openTab('tab4')">4) Список кормів (редагування)</button>
    </div>

    <!-- Вкладка 1: Розрахунок раціону -->
    <div id="tab1" class="tab-content active">
        <div class="desktop-flex">
            <div class="desktop-half">
                <div class="form-group">
                    <label for="species">Вид тварини:</label>
                    <select id="species">
                        <option value="dog">Собака</option>
                        <option value="cat">Кіт</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="currentWeight">Фактична вага (кг):</label>
                    <input type="number" id="currentWeight" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label for="idealWeight">Ідеальна вага (кг):</label>
                    <input type="number" id="idealWeight" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label for="age">Вік (роки):</label>
                    <input type="number" id="age" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label for="activity">Рівень активності:</label>
                    <select id="activity">
                        <option value="low">Низький</option>
                        <option value="moderate">Середній</option>
                        <option value="high">Високий</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="physiology">Фізіологічна особливість:</label>
                    <select id="physiology">
                        <option value="none">Немає</option>
                        <option value="pregnant">Вагітність/Годування</option>
                        <option value="sterilized">Стерилізація</option>
                        <option value="overweight">Надмірна вага</option>
                        <option value="underweight">Недостатня вага</option>
                        <option value="recovery">Відновлення</option>
                        <option value="puppy1">Щеня (фаза 1)</option>
                        <option value="puppy2">Щеня (фаза 2)</option>
                        <option value="kitten">Кошеня</option>
                        <option value="adultDog">Дорослий собака</option>
                        <option value="adultCat">Дорослий кіт</option>
                    </select>
                </div>
                <button class="calculate" onclick="calculateDiet()">Розрахувати</button>
            </div>
            <div class="desktop-half">
                <div id="result"></div>
            </div>
        </div>
    </div>

    <!-- Вкладка 2: Перевірка сумісності корму -->
    <div id="tab2" class="tab-content">
        <p>
            Оберіть корм з бази або введіть свої дані. <br>
            <strong>Усі мінерали та вітаміни (мг чи мкг) вказані на 100 г корму.</strong>
        </p>
        <div class="form-group">
            <label for="feedSelect">Оберіть корм:</label>
            <select id="feedSelect" onchange="onFeedSelected()">
                <option value="">(Не вибрано)</option>
            </select>
        </div>

        <div class="tab2-flex">
            <!-- Макро -->
            <div class="macro-block">
                <h4>Макро (%)</h4>
                <div class="form-group">
                    <label>Білки</label>
                    <input type="number" id="feedProtein" step="0.1" oninput="recalcFeedCarbs()">
                </div>
                <div class="form-group">
                    <label>Жири</label>
                    <input type="number" id="feedFat" step="0.1" oninput="recalcFeedCarbs()">
                </div>
                <div class="form-group">
                    <label>Клітковина</label>
                    <input type="number" id="feedFiber" step="0.1" oninput="recalcFeedCarbs()">
                </div>
                <div class="form-group">
                    <label>Зольність</label>
                    <input type="number" id="feedAsh" step="0.1" oninput="recalcFeedCarbs()">
                </div>
                <div class="form-group">
                    <label>Вологість</label>
                    <input type="number" id="feedMoisture" step="0.1" oninput="recalcFeedCarbs()">
                </div>
                <div class="form-group">
                    <label>Вуглеводи</label>
                    <input type="number" id="feedCarbs" step="0.1" readonly>
                </div>
            </div>

            <!-- Мікро і вітаміни (на 100 г) -->
            <div class="micro-block">
                <h4>Мікро і вітаміни (на 100 г)</h4>
                <div class="form-group">
                    <label>Ca (мг/100г)</label>
                    <input type="number" id="feedCa" step="0.1">
                </div>
                <div class="form-group">
                    <label>P (мг/100г)</label>
                    <input type="number" id="feedP" step="0.1">
                </div>
                <div class="form-group">
                    <label>Fe (мг/100г)</label>
                    <input type="number" id="feedFe" step="0.1">
                </div>
                <div class="form-group">
                    <label>Zn (мг/100г)</label>
                    <input type="number" id="feedZn" step="0.1">
                </div>
                <div class="form-group">
                    <label>Cu (мг/100г)</label>
                    <input type="number" id="feedCu" step="0.1">
                </div>
                <div class="form-group">
                    <label>Mn (мг/100г)</label>
                    <input type="number" id="feedMn" step="0.1">
                </div>
                <div class="form-group">
                    <label>Se (мкг/100г)</label>
                    <input type="number" id="feedSe" step="0.1">
                </div>
                <div class="form-group">
                    <label>I (мкг/100г)</label>
                    <input type="number" id="feedI" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitA (МО)</label>
                    <input type="number" id="feedVitA" step="1">
                </div>
                <div class="form-group">
                    <label>VitD (МО)</label>
                    <input type="number" id="feedVitD" step="1">
                </div>
                <div class="form-group">
                    <label>VitE (МО)</label>
                    <input type="number" id="feedVitE" step="1">
                </div>
                <div class="form-group">
                    <label>VitB1 (мг/100г)</label>
                    <input type="number" id="feedVitB1" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB2 (мг/100г)</label>
                    <input type="number" id="feedVitB2" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB3 (мг/100г)</label>
                    <input type="number" id="feedVitB3" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB4 (мг/100г)</label>
                    <input type="number" id="feedVitB4" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB5 (мг/100г)</label>
                    <input type="number" id="feedVitB5" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB6 (мг/100г)</label>
                    <input type="number" id="feedVitB6" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB7 (мкг/100г)</label>
                    <input type="number" id="feedVitB7" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB9 (мкг/100г)</label>
                    <input type="number" id="feedVitB9" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB12 (мкг/100г)</label>
                    <input type="number" id="feedVitB12" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitC (мг/100г)</label>
                    <input type="number" id="feedVitC" step="0.1">
                </div>
            </div>
        </div>
        <button class="calculate" onclick="checkFeedCompatibility()">Перевірити сумісність</button>
        <div id="compatibilityResult"></div>
    </div>

    <!-- Вкладка 3: Створення нового корму -->
    <div id="tab3" class="tab-content">
        <h2>Додати/Внести новий корм</h2>
        <p>Внесіть усі параметри нижче, дробні значення дозволені (наприклад, 12.5). <br>
           <strong>Усі мінерали та вітаміни (мг чи мкг) – це на 100 г корму.</strong>
        </p>

        <div class="tab3-flex">
            <div class="tab3-half">
                <h4>Макро (%)</h4>
                <div class="form-group">
                    <label>Назва корму</label>
                    <input type="text" id="newFeedName">
                </div>
                <div class="form-group">
                    <label>Білки</label>
                    <input type="number" id="newFeedProtein" step="0.1" oninput="recalcNewCarbs()">
                </div>
                <div class="form-group">
                    <label>Жири</label>
                    <input type="number" id="newFeedFat" step="0.1" oninput="recalcNewCarbs()">
                </div>
                <div class="form-group">
                    <label>Клітковина</label>
                    <input type="number" id="newFeedFiber" step="0.1" oninput="recalcNewCarbs()">
                </div>
                <div class="form-group">
                    <label>Зольність</label>
                    <input type="number" id="newFeedAsh" step="0.1" oninput="recalcNewCarbs()">
                </div>
                <div class="form-group">
                    <label>Вологість</label>
                    <input type="number" id="newFeedMoisture" step="0.1" oninput="recalcNewCarbs()">
                </div>
                <div class="form-group">
                    <label>Вуглеводи</label>
                    <input type="number" id="newFeedCarbs" step="0.1" readonly>
                </div>
            </div>
            <div class="tab3-half">
                <h4>Мікро/Вітаміни (на 100 г)</h4>
                <div class="form-group">
                    <label>Ca (мг/100г)</label>
                    <input type="number" id="newFeedCa" step="0.1">
                </div>
                <div class="form-group">
                    <label>P (мг/100г)</label>
                    <input type="number" id="newFeedP" step="0.1">
                </div>
                <div class="form-group">
                    <label>Fe (мг/100г)</label>
                    <input type="number" id="newFeedFe" step="0.1">
                </div>
                <div class="form-group">
                    <label>Zn (мг/100г)</label>
                    <input type="number" id="newFeedZn" step="0.1">
                </div>
                <div class="form-group">
                    <label>Cu (мг/100г)</label>
                    <input type="number" id="newFeedCu" step="0.1">
                </div>
                <div class="form-group">
                    <label>Mn (мг/100г)</label>
                    <input type="number" id="newFeedMn" step="0.1">
                </div>
                <div class="form-group">
                    <label>Se (мкг/100г)</label>
                    <input type="number" id="newFeedSe" step="0.1">
                </div>
                <div class="form-group">
                    <label>I (мкг/100г)</label>
                    <input type="number" id="newFeedI" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitA (МО)</label>
                    <input type="number" id="newFeedVitA" step="1">
                </div>
                <div class="form-group">
                    <label>VitD (МО)</label>
                    <input type="number" id="newFeedVitD" step="1">
                </div>
                <div class="form-group">
                    <label>VitE (МО)</label>
                    <input type="number" id="newFeedVitE" step="1">
                </div>
                <div class="form-group">
                    <label>VitB1 (мг/100г)</label>
                    <input type="number" id="newFeedVitB1" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB2 (мг/100г)</label>
                    <input type="number" id="newFeedVitB2" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB3 (мг/100г)</label>
                    <input type="number" id="newFeedVitB3" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB4 (мг/100г)</label>
                    <input type="number" id="newFeedVitB4" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB5 (мг/100г)</label>
                    <input type="number" id="newFeedVitB5" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB6 (мг/100г)</label>
                    <input type="number" id="newFeedVitB6" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB7 (мкг/100г)</label>
                    <input type="number" id="newFeedVitB7" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB9 (мкг/100г)</label>
                    <input type="number" id="newFeedVitB9" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitB12 (мкг/100г)</label>
                    <input type="number" id="newFeedVitB12" step="0.1">
                </div>
                <div class="form-group">
                    <label>VitC (мг/100г)</label>
                    <input type="number" id="newFeedVitC" step="0.1">
                </div>
            </div>
        </div>

        <button class="calculate" onclick="addNewFeed()">Зберегти в базу</button>
    </div>

    <!-- Вкладка 4: Список кормів (редагування) -->
    <div id="tab4" class="tab-content">
        <h2>Список внесених кормів</h2>
        <p>Тут можна редагувати чи видаляти наявні корми.<br>
           <strong>* Усі мікроелементи зазначені як (мг/100г) або (мкг/100г), залежно від поля.</strong>
        </p>
        <div id="feedListContainer"></div>
    </div>

    <script>
        /* --- Таби --- */
        function openTab(tabId) {
            document.getElementById('tab1').classList.remove('active');
            document.getElementById('tab2').classList.remove('active');
            document.getElementById('tab3').classList.remove('active');
            document.getElementById('tab4').classList.remove('active');
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'tab4') {
                renderFeedListEditable();
            }
        }

        /* --- ДАНІ --- */
        let feedDB = []; // база кормів
        let globalRecommendedMacros = {
            protein: null,
            fat: null,
            carbs: null,
            fiber: null,
            ash: null,
            moisture: null
        };

        /* --- При завантаженні сторінки --- */
        window.onload = function() {
            loadFeedDB();
            updateFeedSelect(); // для вкладки 2
        };

        /************************************************************
         * 1) Розрахунок раціону (ВКЛ. МІКРО/ВІТАМІНИ УМОВНО)
         ************************************************************/
        function calculateDiet() {
            const species = document.getElementById('species').value;
            const currentWeight = parseFloat(document.getElementById('currentWeight').value);
            const idealWeight = parseFloat(document.getElementById('idealWeight').value);
            const age = parseFloat(document.getElementById('age').value);
            const activity = document.getElementById('activity').value;
            const physiology = document.getElementById('physiology').value;

            if (!currentWeight || !idealWeight || !age) {
                alert('Будь ласка, заповніть усі поля коректно!');
                return;
            }

            // Розрахунок DER
            let RER = 70 * Math.pow(idealWeight, 0.75);
            let DER = RER;
            if (species === 'dog') {
                if (activity === 'low')       DER *= 1.2;
                else if (activity === 'moderate') DER *= 1.4;
                else if (activity === 'high') DER *= 1.8;
            } else {
                // cat
                if (activity === 'low')       DER *= 1.1;
                else if (activity === 'moderate') DER *= 1.3;
                else if (activity === 'high') DER *= 1.5;
            }
            if (physiology === 'puppy1' || physiology === 'kitten') { DER *= 2.0; }
            else if (physiology === 'puppy2') { DER *= 1.6; }
            if (physiology === 'pregnant')   DER *= 2.0;
            if (physiology === 'sterilized') DER *= 0.8;
            if (physiology === 'overweight' || currentWeight > idealWeight * 1.2) { DER *= 0.85; }
            if (physiology === 'underweight'|| currentWeight < idealWeight * 0.8)  { DER *= 1.2; }
            if (physiology === 'recovery')   DER *= 1.3;
            if (age >= 8)                   DER *= 0.9;

            // Макро-діапазони
            const macros = getRecommendedMacros(species, physiology, currentWeight, idealWeight);
            globalRecommendedMacros = {
                protein: macros.proteinRange,
                fat: macros.fatRange,
                carbs: macros.carbRange,
                fiber: macros.fiberRange,
                ash: macros.ashRange,
                moisture: macros.moistureRange
            };

            // Приклад мікро
            const dailyMV = getDailyMineralsVitamins(idealWeight, species, physiology);

            // Дод
            const waterNeeds = Math.round(DER);

            // Вивід
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            let html = `
                <h2>Результат</h2>
                <p><strong>DER:</strong> ~${Math.round(DER)} ккал/день</p>
                <h4>Макро (%):</h4>
                <table>
                    <tr><td>Білки</td><td>${macros.proteinRange}</td></tr>
                    <tr><td>Жири</td><td>${macros.fatRange}</td></tr>
                    <tr><td>Вуглеводи</td><td>${macros.carbRange}</td></tr>
                    <tr><td>Клітковина</td><td>${macros.fiberRange}</td></tr>
                    <tr><td>Зольність</td><td>${macros.ashRange}</td></tr>
                    <tr><td>Вологість</td><td>${macros.moistureRange}</td></tr>
                </table>
                <h4>Мікро/Вітаміни (приблизно, на добу):</h4>
                <table>
                    <tr><td>Ca</td><td>${dailyMV.ca} мг</td></tr>
                    <tr><td>P</td><td>${dailyMV.p} мг</td></tr>
                    <tr><td>Fe</td><td>${dailyMV.fe} мг</td></tr>
                    <tr><td>Zn</td><td>${dailyMV.zn} мг</td></tr>
                    <tr><td>Cu</td><td>${dailyMV.cu} мг</td></tr>
                    <tr><td>Mn</td><td>${dailyMV.mn} мг</td></tr>
                    <tr><td>Se</td><td>${dailyMV.se} мкг</td></tr>
                    <tr><td>I</td><td>${dailyMV.i} мкг</td></tr>
                    <tr><td>VitA</td><td>${dailyMV.vitA} МО</td></tr>
                    <tr><td>VitD</td><td>${dailyMV.vitD} МО</td></tr>
                    <tr><td>VitE</td><td>${dailyMV.vitE} МО</td></tr>
                    <tr><td>VitB1</td><td>${dailyMV.vitB1} мг</td></tr>
                    <tr><td>VitB2</td><td>${dailyMV.vitB2} мг</td></tr>
                    <tr><td>VitB3</td><td>${dailyMV.vitB3} мг</td></tr>
                    <tr><td>VitB4</td><td>${dailyMV.vitB4} мг</td></tr>
                    <tr><td>VitB5</td><td>${dailyMV.vitB5} мг</td></tr>
                    <tr><td>VitB6</td><td>${dailyMV.vitB6} мг</td></tr>
                    <tr><td>VitB7</td><td>${dailyMV.vitB7} мкг</td></tr>
                    <tr><td>VitB9</td><td>${dailyMV.vitB9} мкг</td></tr>
                    <tr><td>VitB12</td><td>${dailyMV.vitB12} мкг</td></tr>
                    <tr><td>VitC</td><td>${dailyMV.vitC} мг</td></tr>
                </table>
                <p>Рекомендована вода: ~${waterNeeds} мл/день</p>
            `;
            resultDiv.innerHTML = html;
        }

        /* Умовні приклади */
        function getRecommendedMacros(species, phys, cW, iW) {
            let pR, fR, cR, fibR, ashR, moistR;
            if (species === 'dog') {
                pR = '18–30%';
                fR = '8–20%';
                cR = '30–50%';
                fibR = '2–5%';
                ashR = '5–10%';
            } else {
                pR = '25–40%';
                fR = '9–25%';
                cR = '20–40%';
                fibR = '1–5%';
                ashR = '5–10%';
            }
            if (phys === 'puppy1' || phys === 'puppy2' || phys === 'kitten') {
                pR = '30–40%';
                fR = '15–25%';
            }
            if (phys === 'overweight' || cW > iW * 1.2) {
                moistR = '0–12%';
            } else if (phys === 'underweight' || cW < iW * 0.8 || phys === 'puppy1' || phys === 'puppy2' || phys === 'kitten') {
                moistR = '46–90%';
            } else {
                moistR = '13–45%';
            }
            return {
                proteinRange: pR, fatRange: fR, carbRange: cR,
                fiberRange: fibR, ashRange: ashR, moistureRange: moistR
            };
        }
        function getDailyMineralsVitamins(iW, species, phys) {
            let base = {};
            if (species === 'dog') {
                base = {
                    ca: 150, p: 120, fe: 2, zn: 2, cu: 0.3, mn: 0.2, se: 3, i: 2,
                    vitA: 1000, vitD: 100, vitE: 50,
                    vitB1: 0.5, vitB2: 0.5, vitB3: 4, vitB4: 25, vitB5: 2,
                    vitB6: 0.4, vitB7: 15, vitB9: 40, vitB12: 3, vitC: 0
                };
            } else {
                base = {
                    ca: 200, p: 160, fe: 2.5, zn: 2.5, cu: 0.4, mn: 0.25, se: 4, i: 3,
                    vitA: 1500, vitD: 120, vitE: 60,
                    vitB1: 0.6, vitB2: 0.7, vitB3: 5, vitB4: 30, vitB5: 3,
                    vitB6: 0.5, vitB7: 20, vitB9: 50, vitB12: 4, vitC: 0
                };
            }
            for (let key in base) {
                base[key] *= iW;
            }
            if (phys === 'puppy1' || phys === 'puppy2' || phys === 'kitten') {
                for (let key in base) {
                    base[key] *= 1.5;
                }
            }
            if (phys === 'pregnant') {
                for (let key in base) {
                    base[key] *= 1.3;
                }
            }
            for (let key in base) {
                base[key] = Math.round(base[key]);
            }
            return base;
        }

        /************************************************************
         * 2) Вкладка «Сумісність корму»
         ************************************************************/
        function onFeedSelected() {
            const feedName = document.getElementById('feedSelect').value;
            if (!feedName) {
                resetSecondTabFields();
                return;
            }
            const found = feedDB.find(x => x.name === feedName);
            if (found) {
                document.getElementById('feedProtein').value = found.protein;
                document.getElementById('feedFat').value = found.fat;
                document.getElementById('feedFiber').value = found.fiber;
                document.getElementById('feedAsh').value = found.ash;
                document.getElementById('feedMoisture').value = found.moisture;
                document.getElementById('feedCarbs').value = found.carbs;
                document.getElementById('feedCa').value = found.ca;
                document.getElementById('feedP').value = found.p;
                document.getElementById('feedFe').value = found.fe;
                document.getElementById('feedZn').value = found.zn;
                document.getElementById('feedCu').value = found.cu;
                document.getElementById('feedMn').value = found.mn;
                document.getElementById('feedSe').value = found.se;
                document.getElementById('feedI').value = found.i;
                document.getElementById('feedVitA').value = found.vitA;
                document.getElementById('feedVitD').value = found.vitD;
                document.getElementById('feedVitE').value = found.vitE;
                document.getElementById('feedVitB1').value = found.vitB1;
                document.getElementById('feedVitB2').value = found.vitB2;
                document.getElementById('feedVitB3').value = found.vitB3;
                document.getElementById('feedVitB4').value = found.vitB4;
                document.getElementById('feedVitB5').value = found.vitB5;
                document.getElementById('feedVitB6').value = found.vitB6;
                document.getElementById('feedVitB7').value = found.vitB7;
                document.getElementById('feedVitB9').value = found.vitB9;
                document.getElementById('feedVitB12').value = found.vitB12;
                document.getElementById('feedVitC').value = found.vitC;
            }
        }
        function resetSecondTabFields() {
            let fields = [
                'feedProtein','feedFat','feedFiber','feedAsh','feedMoisture','feedCarbs',
                'feedCa','feedP','feedFe','feedZn','feedCu','feedMn','feedSe','feedI',
                'feedVitA','feedVitD','feedVitE','feedVitB1','feedVitB2','feedVitB3','feedVitB4',
                'feedVitB5','feedVitB6','feedVitB7','feedVitB9','feedVitB12','feedVitC'
            ];
            fields.forEach(id => document.getElementById(id).value = '');
        }

        function recalcFeedCarbs() {
            const prot = parseFloat(document.getElementById('feedProtein').value) || 0;
            const fat  = parseFloat(document.getElementById('feedFat').value) || 0;
            const fib  = parseFloat(document.getElementById('feedFiber').value) || 0;
            const ash  = parseFloat(document.getElementById('feedAsh').value) || 0;
            const moist= parseFloat(document.getElementById('feedMoisture').value) || 0;
            let sum = prot + fat + fib + ash + moist;
            let carbs = 100 - sum;
            if (carbs < 0) carbs = 0;
            document.getElementById('feedCarbs').value = carbs.toFixed(1);
        }

        function checkFeedCompatibility() {
            // Макро
            if (!globalRecommendedMacros.protein) {
                alert('Спочатку виконайте розрахунок на вкладці 1!');
                return;
            }
            let prot = parseFloat(document.getElementById('feedProtein').value);
            let fat  = parseFloat(document.getElementById('feedFat').value);
            let fib  = parseFloat(document.getElementById('feedFiber').value);
            let ash  = parseFloat(document.getElementById('feedAsh').value);
            let moist= parseFloat(document.getElementById('feedMoisture').value);
            let carbs= parseFloat(document.getElementById('feedCarbs').value);

            const compDiv = document.getElementById('compatibilityResult');
            compDiv.style.display = 'block';

            if ([prot,fat,fib,ash,moist,carbs].some(isNaN)) {
                compDiv.innerHTML = `<h4>Помилка!</h4><p>Заповніть ключові поля макро.</p>`;
                return;
            }

            let out = [];
            function checkRange(fact, rangeStr, label) {
                let r = rangeStr.replace('%','').split('–');
                let low = parseFloat(r[0]);
                let high = parseFloat(r[1]);
                if (fact >= low && fact <= high) {
                    out.push(`<li>${label}: <span style="color:green">в нормі (${fact}%)</span></li>`);
                } else {
                    out.push(`<li>${label}: <span style="color:red">поза межами (${rangeStr})</span> (отримано ${fact}%)</li>`);
                }
            }
            checkRange(prot,  globalRecommendedMacros.protein, 'Білки');
            checkRange(fat,   globalRecommendedMacros.fat, 'Жири');
            checkRange(carbs, globalRecommendedMacros.carbs, 'Вуглеводи');
            checkRange(fib,   globalRecommendedMacros.fiber, 'Клітковина');
            checkRange(ash,   globalRecommendedMacros.ash, 'Зольність');
            checkRange(moist, globalRecommendedMacros.moisture, 'Вологість');

            // Мікро/вітаміни (приклад):
            out.push(`<li><em>Перевірка мікро/вітамінів поки що умовна, без діапазонів</em></li>`);

            compDiv.innerHTML = `
                <h3>Результат перевірки</h3>
                <ul>${out.join('')}</ul>
                <p class="note">
                    Мікроелементи і вітаміни тут не мають встановлених меж у демо-версії.
                </p>
            `;
        }

        /************************************************************
         * 3) Вкладка «Створити новий корм»
         ************************************************************/
        function recalcNewCarbs() {
            const prot = parseFloat(document.getElementById('newFeedProtein').value) || 0;
            const fat  = parseFloat(document.getElementById('newFeedFat').value) || 0;
            const fib  = parseFloat(document.getElementById('newFeedFiber').value) || 0;
            const ash  = parseFloat(document.getElementById('newFeedAsh').value) || 0;
            const moist= parseFloat(document.getElementById('newFeedMoisture').value) || 0;
            let sum = prot + fat + fib + ash + moist;
            let carbs = 100 - sum;
            if (carbs < 0) carbs = 0;
            document.getElementById('newFeedCarbs').value = carbs.toFixed(1);
        }

        function addNewFeed() {
            const name = document.getElementById('newFeedName').value.trim();
            if (!name) {
                alert('Введіть назву корму');
                return;
            }
            // Макро
            const prot = parseFloat(document.getElementById('newFeedProtein').value) || 0;
            const fat  = parseFloat(document.getElementById('newFeedFat').value) || 0;
            const fib  = parseFloat(document.getElementById('newFeedFiber').value) || 0;
            const ash  = parseFloat(document.getElementById('newFeedAsh').value) || 0;
            const moist= parseFloat(document.getElementById('newFeedMoisture').value) || 0;
            const carbs= parseFloat(document.getElementById('newFeedCarbs').value) || 0;
            let total = prot + fat + fib + ash + moist + carbs;
            if (total > 100.1) {
                alert('Сума макропараметрів перевищує 100%.');
                return;
            }

            // Мікро/Вітаміни
            const ca = parseFloat(document.getElementById('newFeedCa').value) || 0;
            const p  = parseFloat(document.getElementById('newFeedP').value)  || 0;
            const fe = parseFloat(document.getElementById('newFeedFe').value) || 0;
            const zn = parseFloat(document.getElementById('newFeedZn').value) || 0;
            const cu = parseFloat(document.getElementById('newFeedCu').value) || 0;
            const mn = parseFloat(document.getElementById('newFeedMn').value) || 0;
            const se = parseFloat(document.getElementById('newFeedSe').value) || 0;
            const i  = parseFloat(document.getElementById('newFeedI').value)  || 0;

            const vitA  = parseFloat(document.getElementById('newFeedVitA').value)  || 0;
            const vitD  = parseFloat(document.getElementById('newFeedVitD').value)  || 0;
            const vitE  = parseFloat(document.getElementById('newFeedVitE').value)  || 0;
            const vitB1 = parseFloat(document.getElementById('newFeedVitB1').value) || 0;
            const vitB2 = parseFloat(document.getElementById('newFeedVitB2').value) || 0;
            const vitB3 = parseFloat(document.getElementById('newFeedVitB3').value) || 0;
            const vitB4 = parseFloat(document.getElementById('newFeedVitB4').value) || 0;
            const vitB5 = parseFloat(document.getElementById('newFeedVitB5').value) || 0;
            const vitB6 = parseFloat(document.getElementById('newFeedVitB6').value) || 0;
            const vitB7 = parseFloat(document.getElementById('newFeedVitB7').value) || 0;
            const vitB9 = parseFloat(document.getElementById('newFeedVitB9').value) || 0;
            const vitB12= parseFloat(document.getElementById('newFeedVitB12').value)|| 0;
            const vitC  = parseFloat(document.getElementById('newFeedVitC').value)  || 0;

            const newFeed = {
                name,
                protein: prot, fat, fiber: fib, ash, moisture: moist, carbs,
                ca, p, fe, zn, cu, mn, se, i,
                vitA, vitD, vitE,
                vitB1, vitB2, vitB3, vitB4, vitB5, vitB6, vitB7, vitB9, vitB12, vitC
            };
            feedDB.push(newFeed);
            saveFeedDB();
            clearNewFeedFields();
            updateFeedSelect(); // Для вкладки 2
            alert('Корм збережено!');
        }

        function clearNewFeedFields() {
            const ids = [
                'newFeedName','newFeedProtein','newFeedFat','newFeedFiber','newFeedAsh','newFeedMoisture','newFeedCarbs',
                'newFeedCa','newFeedP','newFeedFe','newFeedZn','newFeedCu','newFeedMn','newFeedSe','newFeedI',
                'newFeedVitA','newFeedVitD','newFeedVitE','newFeedVitB1','newFeedVitB2','newFeedVitB3','newFeedVitB4',
                'newFeedVitB5','newFeedVitB6','newFeedVitB7','newFeedVitB9','newFeedVitB12','newFeedVitC'
            ];
            ids.forEach(id => document.getElementById(id).value = '');
        }

        /************************************************************
         * 4) Вкладка «Список кормів (редагування)»
         ************************************************************/
        function renderFeedListEditable() {
            const container = document.getElementById('feedListContainer');
            container.innerHTML = '';

            feedDB.forEach((feed, index) => {
                // Розмітка у вигляді "карточки" (feed-row)
                const row = document.createElement('div');
                row.className = 'feed-row';

                // Місце для полів
                const fieldsContainer = document.createElement('div');
                fieldsContainer.style.flex = '1';
                fieldsContainer.style.display = 'flex';
                fieldsContainer.style.flexWrap = 'wrap';
                fieldsContainer.style.gap = '8px';

                // Місце для кнопок
                const actions = document.createElement('div');
                actions.className = 'feed-actions';

                // Створимо поля (з урахуванням розмірностей)
                const nameInput = createField('Назва', feed.name);
                const protInput = createField('Prot (%)', feed.protein, 'number');
                const fatInput  = createField('Fat (%)', feed.fat, 'number');
                const fibInput  = createField('Fib (%)', feed.fiber, 'number');
                const ashInput  = createField('Ash (%)', feed.ash, 'number');
                const moistInput= createField('Moist (%)', feed.moisture, 'number');
                const carbsInput= createField('Carbs (%)', feed.carbs, 'number');
                const caInput   = createField('Ca (мг/100г)', feed.ca, 'number');
                const pInput    = createField('P (мг/100г)',  feed.p,  'number');
                const feInput   = createField('Fe (мг/100г)', feed.fe, 'number');
                const znInput   = createField('Zn (мг/100г)', feed.zn, 'number');
                const cuInput   = createField('Cu (мг/100г)', feed.cu, 'number');
                const mnInput   = createField('Mn (мг/100г)', feed.mn, 'number');
                const seInput   = createField('Se (мкг/100г)', feed.se, 'number');
                const iInput    = createField('I (мкг/100г)',  feed.i,  'number');
                const vitAInput = createField('VitA (МО)', feed.vitA, 'number');
                const vitDInput = createField('VitD (МО)', feed.vitD, 'number');
                const vitEInput = createField('VitE (МО)', feed.vitE, 'number');
                const vitB1Input= createField('B1 (мг/100г)', feed.vitB1, 'number');
                const vitB2Input= createField('B2 (мг/100г)', feed.vitB2, 'number');
                const vitB3Input= createField('B3 (мг/100г)', feed.vitB3, 'number');
                const vitB4Input= createField('B4 (мг/100г)', feed.vitB4, 'number');
                const vitB5Input= createField('B5 (мг/100г)', feed.vitB5, 'number');
                const vitB6Input= createField('B6 (мг/100г)', feed.vitB6, 'number');
                const vitB7Input= createField('B7 (мкг/100г)', feed.vitB7, 'number');
                const vitB9Input= createField('B9 (мкг/100г)', feed.vitB9, 'number');
                const vitB12Input=createField('B12 (мкг/100г)', feed.vitB12, 'number');
                const vitCInput = createField('VitC (мг/100г)', feed.vitC, 'number');

                // Спочатку поля disabled
                [
                    nameInput, protInput, fatInput, fibInput, ashInput, moistInput, carbsInput,
                    caInput, pInput, feInput, znInput, cuInput, mnInput, seInput, iInput,
                    vitAInput, vitDInput, vitEInput, vitB1Input, vitB2Input, vitB3Input, vitB4Input,
                    vitB5Input, vitB6Input, vitB7Input, vitB9Input, vitB12Input, vitCInput
                ].forEach(field => field.querySelector('input').disabled = true);

                // Кнопки edit, save, cancel, delete
                const editBtn = document.createElement('button');
                editBtn.className = 'feed-edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => {
                    row.querySelectorAll('input').forEach(inp => inp.disabled = false);
                    editBtn.style.display = 'none';
                    saveBtn.style.display = 'block';
                    cancelBtn.style.display = 'block';
                };
                const saveBtn = document.createElement('button');
                saveBtn.className = 'feed-save-btn';
                saveBtn.textContent = 'Save';
                saveBtn.style.display = 'none';
                saveBtn.onclick = () => {
                    // Зберегти зміни
                    feed.name      = nameInput.querySelector('input').value;
                    feed.protein   = parseFloat(protInput.querySelector('input').value)||0;
                    feed.fat       = parseFloat(fatInput.querySelector('input').value)||0;
                    feed.fiber     = parseFloat(fibInput.querySelector('input').value)||0;
                    feed.ash       = parseFloat(ashInput.querySelector('input').value)||0;
                    feed.moisture  = parseFloat(moistInput.querySelector('input').value)||0;
                    feed.carbs     = parseFloat(carbsInput.querySelector('input').value)||0;
                    feed.ca        = parseFloat(caInput.querySelector('input').value)||0;
                    feed.p         = parseFloat(pInput.querySelector('input').value)||0;
                    feed.fe        = parseFloat(feInput.querySelector('input').value)||0;
                    feed.zn        = parseFloat(znInput.querySelector('input').value)||0;
                    feed.cu        = parseFloat(cuInput.querySelector('input').value)||0;
                    feed.mn        = parseFloat(mnInput.querySelector('input').value)||0;
                    feed.se        = parseFloat(seInput.querySelector('input').value)||0;
                    feed.i         = parseFloat(iInput.querySelector('input').value)||0;
                    feed.vitA      = parseFloat(vitAInput.querySelector('input').value)||0;
                    feed.vitD      = parseFloat(vitDInput.querySelector('input').value)||0;
                    feed.vitE      = parseFloat(vitEInput.querySelector('input').value)||0;
                    feed.vitB1     = parseFloat(vitB1Input.querySelector('input').value)||0;
                    feed.vitB2     = parseFloat(vitB2Input.querySelector('input').value)||0;
                    feed.vitB3     = parseFloat(vitB3Input.querySelector('input').value)||0;
                    feed.vitB4     = parseFloat(vitB4Input.querySelector('input').value)||0;
                    feed.vitB5     = parseFloat(vitB5Input.querySelector('input').value)||0;
                    feed.vitB6     = parseFloat(vitB6Input.querySelector('input').value)||0;
                    feed.vitB7     = parseFloat(vitB7Input.querySelector('input').value)||0;
                    feed.vitB9     = parseFloat(vitB9Input.querySelector('input').value)||0;
                    feed.vitB12    = parseFloat(vitB12Input.querySelector('input').value)||0;
                    feed.vitC      = parseFloat(vitCInput.querySelector('input').value)||0;

                    saveFeedDB();
                    row.querySelectorAll('input').forEach(inp => inp.disabled = true);
                    editBtn.style.display = 'block';
                    saveBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                    alert('Зміни збережено!');
                };
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'feed-cancel-btn';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.style.display = 'none';
                cancelBtn.onclick = () => {
                    // Відкат до старих значень
                    row.querySelectorAll('input').forEach(inp => inp.disabled = true);
                    nameInput.querySelector('input').value = feed.name;
                    protInput.querySelector('input').value = feed.protein;
                    fatInput.querySelector('input').value  = feed.fat;
                    fibInput.querySelector('input').value  = feed.fiber;
                    ashInput.querySelector('input').value  = feed.ash;
                    moistInput.querySelector('input').value= feed.moisture;
                    carbsInput.querySelector('input').value= feed.carbs;
                    caInput.querySelector('input').value   = feed.ca;
                    pInput.querySelector('input').value    = feed.p;
                    feInput.querySelector('input').value   = feed.fe;
                    znInput.querySelector('input').value   = feed.zn;
                    cuInput.querySelector('input').value   = feed.cu;
                    mnInput.querySelector('input').value   = feed.mn;
                    seInput.querySelector('input').value   = feed.se;
                    iInput.querySelector('input').value    = feed.i;
                    vitAInput.querySelector('input').value = feed.vitA;
                    vitDInput.querySelector('input').value = feed.vitD;
                    vitEInput.querySelector('input').value = feed.vitE;
                    vitB1Input.querySelector('input').value= feed.vitB1;
                    vitB2Input.querySelector('input').value= feed.vitB2;
                    vitB3Input.querySelector('input').value= feed.vitB3;
                    vitB4Input.querySelector('input').value= feed.vitB4;
                    vitB5Input.querySelector('input').value= feed.vitB5;
                    vitB6Input.querySelector('input').value= feed.vitB6;
                    vitB7Input.querySelector('input').value= feed.vitB7;
                    vitB9Input.querySelector('input').value= feed.vitB9;
                    vitB12Input.querySelector('input').value= feed.vitB12;
                    vitCInput.querySelector('input').value = feed.vitC;

                    editBtn.style.display = 'block';
                    saveBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                };
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'feed-delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => {
                    if (confirm('Ви впевнені, що хочете видалити цей корм?')) {
                        feedDB.splice(index, 1);
                        saveFeedDB();
                        renderFeedListEditable();
                        updateFeedSelect();
                    }
                };

                actions.appendChild(editBtn);
                actions.appendChild(saveBtn);
                actions.appendChild(cancelBtn);
                actions.appendChild(deleteBtn);

                [
                    nameInput, protInput, fatInput, fibInput, ashInput, moistInput, carbsInput,
                    caInput, pInput, feInput, znInput, cuInput, mnInput, seInput, iInput,
                    vitAInput, vitDInput, vitEInput, vitB1Input, vitB2Input, vitB3Input, vitB4Input,
                    vitB5Input, vitB6Input, vitB7Input, vitB9Input, vitB12Input, vitCInput
                ].forEach(el => fieldsContainer.appendChild(el));

                row.appendChild(fieldsContainer);
                row.appendChild(actions);
                container.appendChild(row);
            });
        }

        function createField(labelText, value, type='text') {
            let wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.width = '100px';

            let lbl = document.createElement('label');
            lbl.innerText = labelText;
            let inp = document.createElement('input');
            inp.type = type;
            if (type === 'number') {
                inp.step = '0.1';
            }
            inp.value = value ?? '';
            wrapper.appendChild(lbl);
            wrapper.appendChild(inp);

            return wrapper;
        }

        /************************************************************
         * localStorage helpers
         ************************************************************/
        function saveFeedDB() {
            localStorage.setItem('feedDB', JSON.stringify(feedDB));
        }
        function loadFeedDB() {
            const stored = localStorage.getItem('feedDB');
            if (stored) {
                try {
                    feedDB = JSON.parse(stored);
                } catch(e) {
                    feedDB = [];
                }
            } else {
                feedDB = [];
            }
        }

        /* Оновити випадаючий список у вкладці 2 */
        function updateFeedSelect() {
            const feedSelect = document.getElementById('feedSelect');
            feedSelect.innerHTML = '<option value="">(Не вибрано)</option>';
            feedDB.forEach(feed => {
                const opt = document.createElement('option');
                opt.value = feed.name;
                opt.textContent = feed.name;
                feedSelect.appendChild(opt);
            });
        }
    </script>
</body>
</html>
